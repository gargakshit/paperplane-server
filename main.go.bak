package main

import (
	"crypto/rand"
	"encoding/base64"
	"log"
	"net"

	"golang.org/x/crypto/nacl/box"
)

const (
	address = "0.0.0.0:1337"
)

func main() {
	server, err := net.Listen("tcp", address)

	if err != nil {
		log.Fatalln(err)
	}

	defer server.Close()

	log.Println("Sever listening on", address)

	for {
		connection, err := server.Accept()

		if err != nil {
			log.Println(err)
		}

		go handleConnection(connection)
	}
}

func handleConnection(connection net.Conn) {
	defer connection.Close()

	myPubKey, myPrivKey, err := box.GenerateKey(rand.Reader)

	if err != nil {
		log.Println(err)

		connection.Write([]byte("Internal Error"))
		connection.Close()
	}

	base64MyPubKey := base64.StdEncoding.EncodeToString(myPubKey[:])
	base64MyPrivKey := base64.StdEncoding.EncodeToString(myPrivKey[:])

	connection.Write([]byte(base64MyPubKey))
	log.Println("My Key:", base64MyPrivKey)
}
